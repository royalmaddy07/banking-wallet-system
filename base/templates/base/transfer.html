{% extends 'main.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/transfer.css' %}">

<style>
    /* 1. Page Reveal Animation */
    .tx-wrapper {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.7s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .reveal {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }

    /* 2. Interactive Input Focus */
    .tx-input {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tx-input:focus {
        background: #ffffff;
        transform: translateX(5px); /* Subtle shift to show active state */
        border-color: #2563eb;
        box-shadow: -5px 5px 15px rgba(37, 99, 235, 0.05);
    }

    /* 3. Smooth Sidebar Stagger */
    .protocol-card {
        opacity: 0;
        transform: translateX(30px);
        transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1) 0.2s;
    }

    /* 4. Loading State for Button */
    .btn-execute {
        position: relative;
        overflow: hidden;
    }

    .btn-execute.processing {
        background: #475569;
        pointer-events: none;
        color: transparent;
    }

    .btn-execute.processing::after {
        content: "Authorizing Ledger Entry...";
        position: absolute;
        left: 0; top: 0; width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
        color: white; font-size: 0.8rem;
    }
</style>

<div class="tx-wrapper" id="txPage">
    <div class="execution-panel">
        <h2 style="letter-spacing: -1px; font-weight: 800; color: #1e293b;">Initiate Funds Transfer</h2>
        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 30px;">
            Securely transfer liquidity between internal or external ledger accounts.
        </p>

        <form method="POST" action="{% url 'transfer' %}" id="transferForm">
            {% csrf_token %}
            
            <div class="tx-group">
                <label>Source Account (Debit)</label>
                <select name="sender_account_id" class="tx-input" required>
                    <option value="" disabled selected>Select account to debit</option>
                    {% for acc in accounts %}
                        {% if acc.status == 'ACTIVE' %}
                            <option value="{{ acc.accountid }}" {% if preselected_id == acc.accountid|stringformat:"s" %}selected{% endif %}>
                                {{ acc.accounttype }} | {{ acc.accountnumber }} (Balance: ₹{{ acc.balance }})
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="tx-group">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px;">
                    <label style="margin-bottom: 0;">Recipient Details</label>
                    <a href="{% url 'beneficiaries' %}" style="font-size: 0.65rem; color: #3498db; text-decoration: none; font-weight: 700; letter-spacing: 0.5px;">+ MANAGE PAYEES</a>
                </div>

                <select id="beneficiary_selector" class="tx-input" style="margin-bottom: 12px; border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom: 1px dashed #e2e8f0; background-color: #f1f5f9;">
                    <option value="">-- Select Saved Beneficiary --</option>
                    {% for ben in beneficiary_list %}
                        <option value="{{ ben.accountnumber }}">{{ ben.nickname|upper }} ({{ ben.accountnumber }})</option>
                    {% endfor %}
                </select>

                <input type="text" name="receiver_acc_no" id="receiver_acc_no" 
                       class="tx-input" style="border-top-left-radius: 0; border-top-right-radius: 0; font-family: 'JetBrains Mono', monospace;" 
                       placeholder="Enter Account Number manually" 
                       value="{{ request.GET.to_acc|default:'' }}" required>
            </div>

            <div class="tx-group">
                <label>Transfer Amount (INR)</label>
                <input type="number" name="amount" class="tx-input" step="0.01" min="1" placeholder="0.00" required>
            </div>

            <div class="verification-section" style="box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                <h4>Identity Verification</h4>
                <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 20px;">
                    Confirm your credentials to authorize this immutable transaction.
                </p>

                <div class="tx-group">
                    <label>Authorize with Password</label>
                    <input type="password" name="verify_password" class="tx-input" placeholder="••••••••" required>
                </div>

                <div style="display: flex; align-items: flex-start; gap: 10px; margin-top: 15px; background: white; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
                    <input type="checkbox" id="confirm_tx" required style="margin-top: 4px; cursor: pointer;">
                    <label for="confirm_tx" style="font-size: 0.8rem; color: #475569; font-weight: 500; text-transform: none; cursor: pointer; line-height: 1.4;">
                        I verify that the recipient details are accurate and acknowledge that financial transfers are <strong>final and irreversible</strong>.
                    </label>
                </div>

                <button type="submit" class="btn-execute" id="submitBtn">Authorize & Transfer</button>
            </div>
        </form>
    </div>

    <div class="protocol-card" id="sidebarProtocol">
        <h3 style="letter-spacing: 1px;">Security Protocols</h3>
        <ul class="protocol-list">
            <li><span>✓</span> <div><strong>ACID Compliance:</strong> Transactions are atomic and cannot be partially executed.</div></li>
            <li><span>✓</span> <div><strong>Verification:</strong> Recipient account must exist within the BankEngine ecosystem.</div></li>
            <li><span>✓</span> <div><strong>Immutability:</strong> Once authorized, ledger entries cannot be reversed.</div></li>
        </ul>
        
        <div class="security-badge" style="border: 1px solid rgba(255,255,255,0.2);">
            PROTOCOL: SHA-256 x AES-256
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Smooth Reveal on Load
        const page = document.getElementById('txPage');
        const sidebar = document.getElementById('sidebarProtocol');
        
        setTimeout(() => {
            page.classList.add('reveal');
            sidebar.classList.add('reveal');
        }, 100);

        // 2. Beneficiary Selector Logic with Visual Cue
        const selector = document.getElementById('beneficiary_selector');
        const accNoField = document.getElementById('receiver_acc_no');

        selector.addEventListener('change', function() {
            if (this.value) {
                accNoField.value = this.value;
                accNoField.style.backgroundColor = "#eff6ff";
                accNoField.style.borderColor = "#3498db";
                
                // Add a small "pop" effect
                accNoField.style.transform = "scale(1.02)";
                setTimeout(() => accNoField.style.transform = "scale(1)", 200);
            } else {
                accNoField.value = "";
                accNoField.style.backgroundColor = "#f8fafc";
                accNoField.style.borderColor = "#f1f5f9";
            }
        });

        // 3. Submit Button Loading Simulation
        const form = document.getElementById('transferForm');
        const btn = document.getElementById('submitBtn');

        form.addEventListener('submit', () => {
            btn.classList.add('processing');
        });
    });
</script>
{% endblock %}