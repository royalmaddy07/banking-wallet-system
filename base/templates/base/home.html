{% extends 'main.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">

<style>
    /* 1. Global & Entrance Animations */
    .dashboard-container, .dashboard-wrapper {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .reveal {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }

    .data-node {
        opacity: 0;
        transform: translateX(-10px);
        transition: all 0.5s ease;
    }

    /* 2. System Health Pulse */
    .status-indicator {
        width: 10px; height: 10px; border-radius: 50%;
        background: #10b981; display: inline-block; position: relative;
    }

    .status-indicator::after {
        content: ''; position: absolute; width: 100%; height: 100%;
        top: 0; left: 0; background: inherit; border-radius: inherit;
        animation: system-pulse 2s cubic-bezier(0.24, 0, 0.38, 1) infinite;
    }

    @keyframes system-pulse {
        0% { transform: scale(1); opacity: 0.6; }
        70% { transform: scale(3); opacity: 0; }
        100% { transform: scale(1); opacity: 0; }
    }

    /* 3. Account Card Glow Effects */
    .account-card {
        opacity: 0;
        transform: scale(0.95);
        transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Specific Glow per Type */
    .card-savings {
        background: linear-gradient(135deg, #065f46 0%, #10b981 100%) !important;
        box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.3);
    }
    .card-savings:hover {
        box-shadow: 0 20px 40px -10px rgba(16, 185, 129, 0.5);
    }

    .card-current {
        background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%) !important;
        box-shadow: 0 10px 20px -5px rgba(26, 54, 93, 0.3);
    }
    .card-current:hover {
        box-shadow: 0 20px 40px -10px rgba(26, 54, 93, 0.5);
    }

    .card-investment {
        background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%) !important;
        box-shadow: 0 10px 20px -5px rgba(124, 58, 237, 0.3);
    }
    .card-investment:hover {
        box-shadow: 0 20px 40px -10px rgba(124, 58, 237, 0.5);
    }

    .account-card.inactive {
        filter: grayscale(1);
        box-shadow: none !important;
    }

    /* 4. Money Up Styling */
    .balance-amt {
        font-variant-numeric: tabular-nums;
        letter-spacing: -1px;
    }
</style>

<div class="dashboard-container" id="profileSection">
    <div class="dashboard-header">
        <h2>System Dashboard / <span style="color: var(--accent-gold);">{{ request.user.users.name|upper }}</span></h2>
        <div class="engine-id">NODE_ID: {{ request.user.id|add:"1000" }}</div>
    </div>
    
    <div class="profile-grid">
        <div class="data-node">
            <span class="node-label">Auth Identity</span>
            <span class="node-value">{{ request.user.username }}</span>
        </div>
        <div class="data-node">
            <span class="node-label">Network Email</span>
            <span class="node-value">{{ request.user.email }}</span>
        </div>
        <div class="data-node">
            <span class="node-label">Verified Contact</span>
            <span class="node-value">{{ request.user.users.phone }}</span>
        </div>
        <div class="data-node">
            <span class="node-label">Account Status</span>
            <div class="status-container" style="display: flex; align-items: center; gap: 10px; background: rgba(16, 185, 129, 0.05); padding: 5px 15px; border-radius: 20px;">
                <span class="status-indicator"></span>
                <span class="status-text" style="color: #10b981; font-weight: 800; font-size: 0.75rem;">{{ request.user.users.status|upper }}</span>
            </div>
        </div>
    </div>
</div>

<div class="dashboard-wrapper" id="assetsSection">
    <div class="section-header">
        <h3>Your Managed Assets</h3>
        <div class="action-bar">
            {% if active_acc_count < 5 %}
                <a href="{% url 'new_account' %}" class="btn-action">+ New Account</a>
            {% endif %}
            <a href="{% url 'transfer' %}" class="btn-action">Transfer Funds</a>
        </div>
    </div>

    <div class="accounts-grid">
        {% for acc in accounts %}
        <div class="account-card {% if acc.status == 'INACTIVE' %}inactive
                                 {% elif acc.accounttype == 'SAVINGS' %}card-savings
                                 {% elif acc.accounttype == 'CURRENT' %}card-current
                                 {% elif acc.accounttype == 'INVESTMENT' %}card-investment
                                 {% endif %}">
            <span class="card-label">{{ acc.accounttype }}</span>
            
            {% if acc.status == 'INACTIVE' %}
                <div class="closed-badge">Closed</div>
            {% endif %}

            <div class="card-no" style="font-family: 'JetBrains Mono'; color: rgba(255,255,255,0.8);">**** **** {{ acc.accountnumber|slice:"-4:" }}</div>
            
            <div class="balance-info">
                <div style="font-size: 0.7rem; opacity: 0.7; text-transform: uppercase;">Available Balance</div>
                <div class="balance-amt" data-value="{{ acc.balance }}">₹0.00</div>
            </div>

            <div class="card-footer">
                {% if acc.status == 'ACTIVE' %}
                    <a href="{% url 'transfer' %}?from={{ acc.accountid }}" class="btn-card-action">Transfer</a>
                    <a href="{% url 'statements' %}" class="btn-card-action">Statement</a>
                    <a href="{% url 'deactivate_account' acc.accountid %}" class="btn-deactivate">Deactivate</a>
                {% else %}
                    <span class="permanently-closed">TERMINATED</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', () => {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('reveal');
                
                if (entry.target.id === 'profileSection') {
                    entry.target.querySelectorAll('.data-node').forEach((el, i) => {
                        setTimeout(() => { el.style.opacity = '1'; el.style.transform = 'translateX(0)'; }, i * 100);
                    });
                }
                if (entry.target.id === 'assetsSection') {
                    entry.target.querySelectorAll('.account-card').forEach((el, i) => {
                        setTimeout(() => { 
                            el.style.opacity = '1'; 
                            el.style.transform = 'scale(1)'; 
                        }, i * 150);
                    });
                    setTimeout(initCounters, 400);
                }
            }
        });
    }, { threshold: 0.1 });

    observer.observe(document.getElementById('profileSection'));
    observer.observe(document.getElementById('assetsSection'));

    function initCounters() {
        const counters = document.querySelectorAll('.balance-amt');
        counters.forEach(counter => {
            const target = parseFloat(counter.getAttribute('data-value'));
            const duration = 2000;
            const startTimestamp = performance.now();

            const animate = (now) => {
                const elapsed = now - startTimestamp;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = 1 - Math.pow(1 - progress, 3);
                const currentVal = easedProgress * target;

                counter.innerText = '₹' + currentVal.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                if (progress < 1) requestAnimationFrame(animate);
            };
            requestAnimationFrame(animate);
        });
    }
});
</script>
{% endblock %}